<!DOCTYPE html>
<html>
<head>
    <style>
        #c2 {
            background-image: url(assets/image/sfondo.png);
            background-repeat: no-repeat;
        }
        #c1 {
            display: none;
        }
        #video {
            opacity: 0;
        }
    </style>
</head>

<body>
<div>
    <video playsinline="true" controls autoplay muted="true" id="video">
        <source src="assets/videos/corridoio.mp4" type="video/mp4">
    </video>
</div>
<div>
    <canvas id="c1" width="320" height="192"></canvas>
    <canvas id="c2" width="320" height="192"></canvas>
</div>
<script>
    let processor = {
        timerCallback: function() {
            if (this.video.paused || this.video.ended) {
                return;
            }
            this.computeFrame();
            let self = this;
            setTimeout(function () {
                self.timerCallback();
            }, 0);
        },

        doLoad: function() {
            this.video = document.getElementById("video");
            this.c1 = document.getElementById("c1");
            this.ctx1 = this.c1.getContext("2d");
            this.c2 = document.getElementById("c2");
            this.ctx2 = this.c2.getContext("2d");
            let self = this;
            this.video.addEventListener("play", function() {
                self.width = self.video.videoWidth / 6;
                self.height = self.video.videoHeight / 6;
                self.timerCallback();
            }, false);
        },

        computeFrame: function() {
            this.ctx1.drawImage(this.video, 0, 0, this.width, this.height);
            let frame = this.ctx1.getImageData(0, 0, this.width, this.height);
            let l = frame.data.length / 4;

            for (let i = 0; i < l; i++) {
                let r = frame.data[i * 4];
                let g = frame.data[i * 4 + 1];
                let b = frame.data[i * 4 + 2];
                if (g > 168 && r < 52 && b > 83)
                    frame.data[i * 4 + 3] = 0;
            }
            this.ctx2.putImageData(frame, 0, 0);
        }
    };

    document.addEventListener("DOMContentLoaded", () => {
        processor.doLoad();
    });
</script>
</body>
</html>